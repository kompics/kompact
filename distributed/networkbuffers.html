<!DOCTYPE HTML>
<html lang="en" class="sidebar-visible no-js light">
    <head>
        <!-- Book generated using mdBook -->
        <meta charset="UTF-8">
        <title>Configuring Buffers - The Kompact Book</title>
        
        


        <!-- Custom HTML head -->
        


        <meta content="text/html; charset=utf-8" http-equiv="Content-Type">
        <meta name="description" content="A User Guide, Manual, and Tutorial for the Kompact actor-component-hybrid systems.">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="theme-color" content="#ffffff" />

        
        <link rel="icon" href="../favicon.svg">
        
        
        <link rel="shortcut icon" href="../favicon.png">
        
        <link rel="stylesheet" href="../css/variables.css">
        <link rel="stylesheet" href="../css/general.css">
        <link rel="stylesheet" href="../css/chrome.css">
        
        <link rel="stylesheet" href="../css/print.css" media="print">
        

        <!-- Fonts -->
        <link rel="stylesheet" href="../FontAwesome/css/font-awesome.css">
        
        <link rel="stylesheet" href="../fonts/fonts.css">
        

        <!-- Highlight.js Stylesheets -->
        <link rel="stylesheet" href="../highlight.css">
        <link rel="stylesheet" href="../tomorrow-night.css">
        <link rel="stylesheet" href="../ayu-highlight.css">

        <!-- Custom theme stylesheets -->
        

        
        <!-- MathJax -->
        <script async type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.1/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
        
    </head>
    <body>
        <!-- Provide site root to javascript -->
        <script type="text/javascript">
            var path_to_root = "../";
            var default_theme = window.matchMedia("(prefers-color-scheme: dark)").matches ? "ayu" : "light";
        </script>

        <!-- Work around some values being stored in localStorage wrapped in quotes -->
        <script type="text/javascript">
            try {
                var theme = localStorage.getItem('mdbook-theme');
                var sidebar = localStorage.getItem('mdbook-sidebar');

                if (theme.startsWith('"') && theme.endsWith('"')) {
                    localStorage.setItem('mdbook-theme', theme.slice(1, theme.length - 1));
                }

                if (sidebar.startsWith('"') && sidebar.endsWith('"')) {
                    localStorage.setItem('mdbook-sidebar', sidebar.slice(1, sidebar.length - 1));
                }
            } catch (e) { }
        </script>

        <!-- Set the theme before any content is loaded, prevents flash -->
        <script type="text/javascript">
            var theme;
            try { theme = localStorage.getItem('mdbook-theme'); } catch(e) { }
            if (theme === null || theme === undefined) { theme = default_theme; }
            var html = document.querySelector('html');
            html.classList.remove('no-js')
            html.classList.remove('light')
            html.classList.add(theme);
            html.classList.add('js');
        </script>

        <!-- Hide / unhide sidebar before it is displayed -->
        <script type="text/javascript">
            var html = document.querySelector('html');
            var sidebar = 'hidden';
            if (document.body.clientWidth >= 1080) {
                try { sidebar = localStorage.getItem('mdbook-sidebar'); } catch(e) { }
                sidebar = sidebar || 'visible';
            }
            html.classList.remove('sidebar-visible');
            html.classList.add("sidebar-" + sidebar);
        </script>

        <nav id="sidebar" class="sidebar" aria-label="Table of contents">
            <div class="sidebar-scrollbox">
                <ol class="chapter"><li class="chapter-item expanded affix "><a href="../foreword.html">Foreword</a></li><li class="chapter-item expanded affix "><a href="../getting-started.html">Getting Started</a></li><li class="chapter-item expanded "><a href="../introduction/index.html"><strong aria-hidden="true">1.</strong> Introduction</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../introduction/components.html"><strong aria-hidden="true">1.1.</strong> Components</a></li><li class="chapter-item expanded "><a href="../introduction/actors.html"><strong aria-hidden="true">1.2.</strong> Actors</a></li><li class="chapter-item expanded "><a href="../introduction/state.html"><strong aria-hidden="true">1.3.</strong> Internal State</a></li></ol></li><li class="chapter-item expanded "><a href="../local/index.html"><strong aria-hidden="true">2.</strong> Local Kompact</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../local/communication/index.html"><strong aria-hidden="true">2.1.</strong> Communication</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../local/communication/messagesandevents.html"><strong aria-hidden="true">2.1.1.</strong> Messages and Events</a></li><li class="chapter-item expanded "><a href="../local/communication/state.html"><strong aria-hidden="true">2.1.2.</strong> State</a></li><li class="chapter-item expanded "><a href="../local/communication/handlers.html"><strong aria-hidden="true">2.1.3.</strong> Handlers</a></li><li class="chapter-item expanded "><a href="../local/communication/ask.html"><strong aria-hidden="true">2.1.4.</strong> Ask</a></li><li class="chapter-item expanded "><a href="../local/communication/system.html"><strong aria-hidden="true">2.1.5.</strong> System</a></li><li class="chapter-item expanded "><a href="../local/communication/senders.html"><strong aria-hidden="true">2.1.6.</strong> Senders</a></li></ol></li><li class="chapter-item expanded "><a href="../local/timers.html"><strong aria-hidden="true">2.2.</strong> Timers</a></li><li class="chapter-item expanded "><a href="../local/schedulers.html"><strong aria-hidden="true">2.3.</strong> Schedulers</a></li><li class="chapter-item expanded "><a href="../local/logging.html"><strong aria-hidden="true">2.4.</strong> Logging</a></li><li class="chapter-item expanded "><a href="../local/configuration.html"><strong aria-hidden="true">2.5.</strong> Configuration</a></li><li class="chapter-item expanded "><a href="../local/faultrecovery.html"><strong aria-hidden="true">2.6.</strong> Fault Recovery</a></li><li class="chapter-item expanded "><a href="../local/dynamic-components.html"><strong aria-hidden="true">2.7.</strong> Dynamic Components</a></li></ol></li><li class="chapter-item expanded "><a href="../distributed/index.html"><strong aria-hidden="true">3.</strong> Distributed Kompact</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../distributed/basiccommunication.html"><strong aria-hidden="true">3.1.</strong> Basic Communication</a></li><li class="chapter-item expanded "><a href="../distributed/namedservices.html"><strong aria-hidden="true">3.2.</strong> Named Services</a></li><li class="chapter-item expanded "><a href="../distributed/pathrouting.html"><strong aria-hidden="true">3.3.</strong> Path Routing</a></li><li class="chapter-item expanded "><a href="../distributed/serialisation.html"><strong aria-hidden="true">3.4.</strong> Serialisation</a></li><li class="chapter-item expanded "><a href="../distributed/networkbuffers.html" class="active"><strong aria-hidden="true">3.5.</strong> Configuring Buffers</a></li><li class="chapter-item expanded "><a href="../distributed/networkstatusport.html"><strong aria-hidden="true">3.6.</strong> Network Status Port</a></li></ol></li><li class="chapter-item expanded "><a href="../async/index.html"><strong aria-hidden="true">4.</strong> Async/Await Interaction</a></li><li class="chapter-item expanded affix "><a href="../project.html">Project Info</a></li></ol>
            </div>
            <div id="sidebar-resize-handle" class="sidebar-resize-handle"></div>
        </nav>

        <div id="page-wrapper" class="page-wrapper">

            <div class="page">
                
                <div id="menu-bar-hover-placeholder"></div>
                <div id="menu-bar" class="menu-bar sticky bordered">
                    <div class="left-buttons">
                        <button id="sidebar-toggle" class="icon-button" type="button" title="Toggle Table of Contents" aria-label="Toggle Table of Contents" aria-controls="sidebar">
                            <i class="fa fa-bars"></i>
                        </button>
                        <button id="theme-toggle" class="icon-button" type="button" title="Change theme" aria-label="Change theme" aria-haspopup="true" aria-expanded="false" aria-controls="theme-list">
                            <i class="fa fa-paint-brush"></i>
                        </button>
                        <ul id="theme-list" class="theme-popup" aria-label="Themes" role="menu">
                            <li role="none"><button role="menuitem" class="theme" id="light">Light (default)</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="rust">Rust</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="coal">Coal</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="navy">Navy</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="ayu">Ayu</button></li>
                        </ul>
                        
                        <button id="search-toggle" class="icon-button" type="button" title="Search. (Shortkey: s)" aria-label="Toggle Searchbar" aria-expanded="false" aria-keyshortcuts="S" aria-controls="searchbar">
                            <i class="fa fa-search"></i>
                        </button>
                        
                    </div>

                    <h1 class="menu-title">The Kompact Book</h1>

                    <div class="right-buttons">
                        
                        <a href="../print.html" title="Print this book" aria-label="Print this book">
                            <i id="print-button" class="fa fa-print"></i>
                        </a>
                        
                        
                        <a href="https://github.com/kompics/kompact" title="Git repository" aria-label="Git repository">
                            <i id="git-repository-button" class="fa fa-github"></i>
                        </a>
                        
                    </div>
                </div>

                
                <div id="search-wrapper" class="hidden">
                    <form id="searchbar-outer" class="searchbar-outer">
                        <input type="search" name="search" id="searchbar" name="searchbar" placeholder="Search this book ..." aria-controls="searchresults-outer" aria-describedby="searchresults-header">
                    </form>
                    <div id="searchresults-outer" class="searchresults-outer hidden">
                        <div id="searchresults-header" class="searchresults-header"></div>
                        <ul id="searchresults">
                        </ul>
                    </div>
                </div>
                

                <!-- Apply ARIA attributes after the sidebar and the sidebar toggle button are added to the DOM -->
                <script type="text/javascript">
                    document.getElementById('sidebar-toggle').setAttribute('aria-expanded', sidebar === 'visible');
                    document.getElementById('sidebar').setAttribute('aria-hidden', sidebar !== 'visible');
                    Array.from(document.querySelectorAll('#sidebar a')).forEach(function(link) {
                        link.setAttribute('tabIndex', sidebar === 'visible' ? 0 : -1);
                    });
                </script>

                <div id="content" class="content">
                    <main>
                        <h1 id="network-buffers"><a class="header" href="#network-buffers">Network Buffers</a></h1>
<p>Kompact uses a BufferPool system to serialize network messages. This section describes the BufferPools briefly and how they can be configured with different parameters.</p>
<p>Before we begin describing the Network Buffers we remind the reader that there are two different methods for sending messages over the network in Kompact:</p>
<ol>
<li><strong>Lazy serialisation</strong> <code>dst.tell(msg: M, from: S);</code></li>
<li><strong>Eager serialisation</strong> <code>dst.tell_serialised(msg: M, from: &amp;self);</code></li>
</ol>
<p>With lazy serialisation the Actor moves the data to the heap, and transfers it unserialised to the <code>NetworkDispatcher</code>, which later serialises the message into its (the <code>NetworkDispatcher</code>‘s) own buffers.<br />
Eager serialisation serialises the data immediately into the Actor’s buffers, and then transfers ownership of the serialised the data to the <code>NetworkDispatcher</code>.</p>
<p>Lazy serialisation may fail due to two reasons: A serialisation error, or there are no available buffers. Both will be
unnoticeable to the actor initiating the message sending, and both will lead to the message being lost.</p>
<h2 id="how-the-buffer-pools-work"><a class="header" href="#how-the-buffer-pools-work">How the Buffer Pools work</a></h2>
<h3 id="buffer-pool-locations"><a class="header" href="#buffer-pool-locations">Buffer Pool locations</a></h3>
<p>In a Kompact system where many actors use eager serialisation there will be many <code>BufferPool</code> instances. If the actors in the system only use lazy serialisation there will be a single pool, owned by the <code>NetworkThread</code> for serialising and receiving data.</p>
<h3 id="bufferpool-bufferchunk-and-chunklease"><a class="header" href="#bufferpool-bufferchunk-and-chunklease">BufferPool, BufferChunk, and ChunkLease</a></h3>
<p>Each <code>BufferPool</code> (pool) consists of more than one <code>BufferChunk</code> (chunks). A chunk is the concrete memory area used for serialising data into. There may be many messages serialised into a single chunk, and discrete slices of the chunks (i.e. individual messages) can be extracted and sent to other threads/actors through the smart-pointer <code>ChunkLease</code> (lease). When a chunk runs out of space it will be locked and returned to the pool. If and only if all outstanding leases created from a chunk have been dropped may the chunk be unlocked and reused, or deallocated.</p>
<p>When a pool is created it will pre-allocate a configurable amount of chunks, and will attempt to reuse those as long as possible, and only when it needs to will it allocate more chunks, up to a configurable maximum number of chunks. </p>
<h3 id="bufferpool-interface"><a class="header" href="#bufferpool-interface">BufferPool interface</a></h3>
<p>Actors access their pool through the <code>EncodeBuffer</code> wrapper which maintains a single active chunk at a time, and automatically swaps the active buffer with the local <code>BufferPool</code> when necessary.</p>
<p>The method <code>tell_serialised(msg, &amp;self)</code> automatically uses the <code>EncodeBuffer</code> interface such that users of Kompact do not need to use the interfaces of the pool (which is why the method requires a <code>self</code> reference). </p>
<h3 id="bufferpool-initialization"><a class="header" href="#bufferpool-initialization">BufferPool initialization</a></h3>
<p>Actors initialize their local buffers automatically when the first invocation of <code>tell_serialised(...)</code> occurs. If an Actor never invokes the method it will not allocate any buffers.</p>
<p>An actor may call the initialization method through the call <code>self.ctx.borrow().init_buffers(None, None);</code><sup class="footnote-reference"><a href="#1">1</a></sup> to explicitly initialize the local <code>BufferPool</code> without sending a message.</p>
<h2 id="bufferconfig"><a class="header" href="#bufferconfig">BufferConfig</a></h2>
<h3 id="parameters"><a class="header" href="#parameters">Parameters</a></h3>
<p>There are four configurable parameters in the BufferConfig:</p>
<ol>
<li><code>chunk_size</code>: The size (in bytes) of the <code>BufferChunks</code>. Default value is 128KB.</li>
<li><code>initial_chunk_count</code>: How many <code>BufferChunks</code> the <code>BufferPool</code> will pre-allocate. Default value is 2.</li>
<li><code>max_chunk_count</code>: The maximum number of <code>BufferChunks</code> the <code>BufferPool</code> may have allocated simultaneously. Default value is 1000.</li>
<li><code>encode_buf_min_free_space</code>: When an Actor begins serialising a message the <code>EncodeBuffer</code> will compare how much space (in bytes) is left in the active chunk and compare it to this parameter, if there is less free space the active chunk will be replaced with a new one from the pool before continuing the serialisation. Default value is 64 bytes.</li>
</ol>
<h3 id="configuring-the-buffers"><a class="header" href="#configuring-the-buffers">Configuring the Buffers</a></h3>
<h4 id="individual-actor-configuration"><a class="header" href="#individual-actor-configuration">Individual Actor Configuration</a></h4>
<p>If no <code>BufferConfig</code> is specified Kompact will use the default settings for all <code>BufferPools</code>. Actors may be configured with individual <code>BufferConfigs</code> through the <code>init_buffer(Some(config), None)</code><sup class="footnote-reference"><a href="#1">1</a></sup> config. It is important that the call is made before any calls to <code>tell_serialised(...)</code>. For example, the <code>on_start()</code> function of the <code>ComponentLifecycle</code> may be used to ensure this, as in the following example:</p>
<pre><code class="language-rust edition2018 no_run noplaypen">impl ComponentLifecycle for CustomBufferConfigActor {
    fn on_start(&amp;mut self) -&gt; Handled {
        let mut buffer_config = BufferConfig::default();
        buffer_config.encode_buf_min_free_space(128);
        buffer_config.max_chunk_count(5);
        buffer_config.initial_chunk_count(4);
        buffer_config.chunk_size(256*1024);
        
        self.ctx.borrow().init_buffers(Some(buffer_config), None);
        Handled::Ok
    }
    ...
}
</code></pre>
<h4 id="configuring-all-actors"><a class="header" href="#configuring-all-actors">Configuring All Actors</a></h4>
<p>If a programmer wishes for all actors to use the same <code>BufferConfig</code> configuration, a Hocon string can be inserted into the <code>KompactConfig</code> or loaded from a Hocon-file (<a href="./../local/configuration.html">see configuration chapter on loading configurations</a>), for example: </p>
<pre><code class="language-rust edition2018 no_run noplaypen">let mut cfg = KompactConfig::new();
cfg.load_config_str(
    r#&quot;{
        buffer_config {
            chunk_size: &quot;256KB&quot;,
            initial_chunk_count: 3,
            max_chunk_count: 4,
            encode_min_remaining: &quot;20B&quot;,
        }
        }&quot;#,
);
...
let system = cfg.build().expect(&quot;KompactSystem&quot;);
</code></pre>
<p>If a <code>BufferConfig</code> is loaded into the systems <code>KompactConfig</code> then all actors will use that configuration instead of the default <code>BufferConfig</code>, however individual actors may still override the configuration by using the <code>init_buffers(...)</code> method.</p>
<h4 id="configuring-the-networkdispatcher-and-networkthread"><a class="header" href="#configuring-the-networkdispatcher-and-networkthread">Configuring the NetworkDispatcher and NetworkThread</a></h4>
<p>The <code>NetworkDispatcher</code> and <code>NetworkThread</code> are configured separately from the Actors and use their buffers for lazy serialisation and receiving data from the network. To configure their buffers the <code>NetworkConfig</code> may be created using the method <code>::with_buffer_config(...)</code> as in the example below:</p>
<pre><code class="language-rust edition2018 no_run noplaypen">let mut cfg = KompactConfig::new();
let mut network_buffer_config = BufferConfig::default();
network_buffer_config.chunk_size(512);
network_buffer_config.initial_chunk_count(2);
network_buffer_config.max_chunk_count(3);
network_buffer_config.encode_buf_min_free_space(10);
cfg.system_components(DeadletterBox::new, {
    NetworkConfig::with_buffer_config(
        &quot;127.0.0.1:0&quot;.parse().expect(&quot;Address should work&quot;),
        network_buffer_config,
    )
    .build()
});
let system = cfg.build().expect(&quot;KompactSystem&quot;);
</code></pre>
<h4 id="bufferconfig-validation"><a class="header" href="#bufferconfig-validation">BufferConfig Validation</a></h4>
<p><code>BufferConfig</code> implements the method <code>validate()</code> which causes a panic if the set of parameters is invalid. It is invoked whenever a <code>BufferPool</code> is created from the given configuration. The validation checks that the following conditions hold true:</p>
<ul>
<li><code>chunk_size &gt; encode_buf_min_free_space</code></li>
<li><code>chunk_size &gt; 127</code></li>
<li><code>max_chunk_count &gt;= initial_chunk_count</code></li>
</ul>
<hr />
<div class="footnote-definition" id="1"><sup class="footnote-definition-label">1</sup>
<p>The method <code>init_buffers(...)</code> takes two <code>Option</code> arguments, of which the second argument has not been covered. The second argument allows users of Kompact to specify a <code>CustomAllocator</code>: a poorly tested, experimental feature which is left undocumented for the time being. </p>
</div>

                    </main>

                    <nav class="nav-wrapper" aria-label="Page navigation">
                        <!-- Mobile navigation buttons -->
                        
                            <a rel="prev" href="../distributed/serialisation.html" class="mobile-nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                                <i class="fa fa-angle-left"></i>
                            </a>
                        

                        
                            <a rel="next" href="../distributed/networkstatusport.html" class="mobile-nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                                <i class="fa fa-angle-right"></i>
                            </a>
                        

                        <div style="clear: both"></div>
                    </nav>
                </div>
            </div>

            <nav class="nav-wide-wrapper" aria-label="Page navigation">
                
                    <a rel="prev" href="../distributed/serialisation.html" class="nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                        <i class="fa fa-angle-left"></i>
                    </a>
                

                
                    <a rel="next" href="../distributed/networkstatusport.html" class="nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                        <i class="fa fa-angle-right"></i>
                    </a>
                
            </nav>

        </div>

        

        

        

        
        <script type="text/javascript">
            window.playground_copyable = true;
        </script>
        

        

        
        <script src="../elasticlunr.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="../mark.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="../searcher.js" type="text/javascript" charset="utf-8"></script>
        

        <script src="../clipboard.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="../highlight.js" type="text/javascript" charset="utf-8"></script>
        <script src="../book.js" type="text/javascript" charset="utf-8"></script>

        <!-- Custom JS scripts -->
        

        

    </body>
</html>
